version: '3.4'

services:
  gateway:
    image: ${DOCKER_REGISTRY-}gateway
    build:
      context: .
      dockerfile: Gateway/Dockerfile
    networks:
      - backend
    depends_on:
      - blogservice
      - authenticationservice

  blogservice:
    image: villsource/blogservice
    environment:
      DB_CONNECTION_STRING: Server=blog-database;Database=BlogService;User=sa;Password=P@ssword;TrustServerCertificate=True;
      ASPNETCORE_ENVIRONMENT: Development
      ASPNETCORE_URLS: http://+:80
      AUTH_SERVER: http://authenticationservice
    volumes:
      - ${APPDATA}/Microsoft/UserSecrets:/root/.microsoft/usersecrets:ro
      - ${APPDATA}/ASP.NET/Https:/root/.aspnet/https:ro
    networks:
      - backend
    depends_on:
      - blog-database

  authenticationservice:
    image: villsource/authenticationservice
    environment: 
      DB_CONNECTION_STRING: Server=blog-database;Database=authentication;User=sa;Password=P@ssword;TrustServerCertificate=True;
      ASPNETCORE_ENVIRONMENT: Development
      ASPNETCORE_URLS: http://+:80
      ISSURE: http://authenticationservice 
    volumes:
      - ${APPDATA}/Microsoft/UserSecrets:/root/.microsoft/usersecrets:ro
      - ${APPDATA}/ASP.NET/Https:/root/.aspnet/https:ro
    networks:
      - backend
    depends_on:
      - blog-database

  picturestorageservice:
    image: villsource/picturestorageservice
    environment:
      DB_CONNECTION_STRING: mongodb://user:pass@mongodb/admin
      ASPNETCORE_ENVIRONMENT: Development
      ASPNETCORE_URLS: http://+:80
    ports:
      - "30000:80"
    volumes:
      - C:\Users\Anirut\Pictures\img-storage:/img-storage
    depends_on:
      - mongodb
    networks:
      - backend




  blog-database:
    image: mcr.microsoft.com/mssql/server:2019-latest
    environment:
      - ACCEPT_EULA=Y
      - MSSQL_SA_PASSWORD=P@ssword
    ports:
      - "1434:1433"
    volumes:
      - "blog-service:/var/opt/mssql"
    networks:
      - backend

  mongodb:
    image: mongodb/mongodb-community-server:6.0-ubi8
    environment:
      - MONGO_INITDB_ROOT_USERNAME=user
      - MONGO_INITDB_ROOT_PASSWORD=pass
    volumes:
      - db:/data/db
    ports:
      - 27017:27017
    networks:
      - backend



volumes:
  blog-service:
  db:

networks:
  backend:
